define("local_hlai_grading/grade_explanation",["jquery","core/ajax","core/notification","core/templates","core/str"],(function($,Ajax,Notification,Templates,Str){const stringDefs=[{key:"explain_grade",component:"local_hlai_grading"},{key:"hide_explanation",component:"local_hlai_grading"},{key:"explanation_panel_title",component:"local_hlai_grading"},{key:"explanation_panel_intro",component:"local_hlai_grading"},{key:"explanation_loading",component:"local_hlai_grading"},{key:"explanation_error",component:"local_hlai_grading"},{key:"explanation_not_available",component:"local_hlai_grading"},{key:"explanation_overall_heading",component:"local_hlai_grading"},{key:"explanation_strengths_heading",component:"local_hlai_grading"},{key:"explanation_strengths_empty",component:"local_hlai_grading"},{key:"explanation_improvements_heading",component:"local_hlai_grading"},{key:"explanation_improvements_empty",component:"local_hlai_grading"},{key:"explanation_criteria_heading",component:"local_hlai_grading"},{key:"explanation_examples_heading",component:"local_hlai_grading"},{key:"explanation_expand_all",component:"local_hlai_grading"},{key:"explanation_collapse_all",component:"local_hlai_grading"},{key:"explanation_confidence",component:"local_hlai_grading"},{key:"explanation_points",component:"local_hlai_grading"},{key:"explanation_toggle_show",component:"local_hlai_grading"},{key:"explanation_toggle_hide",component:"local_hlai_grading"}],formatNumber=value=>{if(null==value||""===value)return"â€“";const number=Number(value);return Number.isNaN(number)?value:Number.isInteger(number)?number.toString():number.toFixed(2)},toParagraphs=text=>text?text.split(/\n+/).map((part=>part.trim())).filter(Boolean):[],renderExplanation=(panel,data,strings)=>{const context=((data,strings)=>{const confidenceValue=Number(data.confidence),templateData={gradevalue:formatNumber(data.grade),grademax:formatNumber(data.maxgrade),hasconfidence:Number.isFinite(confidenceValue)&&confidenceValue>0,confidence:strings.explanation_confidence.replace("{$a}",confidenceValue.toString()),hasreasoning:!!data.reasoning,reasoningparagraphs:toParagraphs(data.reasoning),overallheading:strings.explanation_overall_heading,strengthsheading:strings.explanation_strengths_heading,improvementsheading:strings.explanation_improvements_heading,improvementsempty:strings.explanation_improvements_empty,criteriaheading:strings.explanation_criteria_heading,examplesheading:strings.explanation_examples_heading,expandall:strings.explanation_expand_all,collapseall:strings.explanation_collapse_all,strengthsempty:strings.explanation_strengths_empty,strengths:data.strengths||[],improvements:data.improvements||[],hasstrengths:Array.isArray(data.strengths)&&data.strengths.length>0,hasimprovements:Array.isArray(data.improvements)&&data.improvements.length>0};return templateData.criteria=(data.criteria||[]).map(((criterion,index)=>{const id=criterion.id||index,maxpoints=void 0!==criterion.maxpoints&&null!==criterion.maxpoints?criterion.maxpoints:void 0!==criterion.max_score?criterion.max_score:"",pointsLabel=strings.explanation_points.replace("{$a->points}",formatNumber(criterion.points)).replace("{$a->maxpoints}",formatNumber(maxpoints));return{id:id,name:criterion.name||"Criterion",levelname:criterion.level_name||criterion.levelname||"",pointslabel:pointsLabel,togglelabel:strings.explanation_toggle_show,hasreasoning:!!criterion.reasoning,reasoningparagraphs:toParagraphs(criterion.reasoning)}})),templateData.hascriteria=templateData.criteria.length>0,templateData.hasexamples=Array.isArray(data.highlighted_examples)&&data.highlighted_examples.length>0,templateData.examples=(data.highlighted_examples||[]).map((example=>({label:example.label||"",text:example.text||"",comment:example.comment||"",typeclass:"strength"===(example.type||"").toLowerCase()?"strength":"improvement"}))),templateData})(data,strings);return Templates.render("local_hlai_grading/student_explanation",context).then((function(html,js){panel.innerHTML=html,Templates.runTemplateJS(js),((panel,strings)=>{panel.querySelectorAll(".criterion-explain-btn").forEach((button=>{button.addEventListener("click",(()=>{const target=panel.querySelector("#reasoning-"+button.dataset.criterionid);target&&("true"===button.getAttribute("aria-expanded")?(target.style.display="none",button.setAttribute("aria-expanded","false"),button.textContent=strings.explanation_toggle_show):(target.style.display="block",button.setAttribute("aria-expanded","true"),button.textContent=strings.explanation_toggle_hide))}))}));const expandAll=panel.querySelector("#expand-all-criteria"),collapseAll=panel.querySelector("#collapse-all-criteria");expandAll&&expandAll.addEventListener("click",(()=>{panel.querySelectorAll(".criterion-reasoning").forEach((reasoning=>{reasoning.style.display="block"})),panel.querySelectorAll(".criterion-explain-btn").forEach((button=>{button.setAttribute("aria-expanded","true"),button.textContent=strings.explanation_toggle_hide}))})),collapseAll&&collapseAll.addEventListener("click",(()=>{panel.querySelectorAll(".criterion-reasoning").forEach((reasoning=>{reasoning.style.display="none"})),panel.querySelectorAll(".criterion-explain-btn").forEach((button=>{button.setAttribute("aria-expanded","false"),button.textContent=strings.explanation_toggle_show}))}))})(panel,strings)}))};return{init:config=>{config&&config.submissionid&&Str.get_strings(stringDefs).then((function(results){const map={};return results.forEach((function(value,index){map[stringDefs[index].key]=value})),map})).then((strings=>{const card=(strings=>{const table=document.querySelector("#page-mod-assign-view .submissionstatustable");if(!table)return null;const card=document.createElement("div");return card.className="card ai-grade-explain-card mb-4",card.innerHTML='\n            <div class="card-body">\n                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">\n                    <div>\n                        <h4 class="card-title mb-1">'.concat(strings.explanation_panel_title,'</h4>\n                        <p class="text-muted mb-0">').concat(strings.explanation_panel_intro,'</p>\n                    </div>\n                    <button type="button"\n                        id="explain-grade-btn"\n                        class="btn btn-outline-primary"\n                        aria-expanded="false">\n                        ').concat(strings.explain_grade,'\n                    </button>\n                </div>\n                <div id="grade-explanation-panel" class="mt-3" hidden>\n                    <div class="ai-explain-loading">\n                        ').concat(strings.explanation_loading,"\n                    </div>\n                </div>\n            </div>\n        "),table.parentNode.insertBefore(card,table.nextSibling),card})(strings);if(!card)return;const button=card.querySelector("#explain-grade-btn"),panel=card.querySelector("#grade-explanation-panel");let loaded=!1;const toggleButtonState=expanded=>{button.setAttribute("aria-expanded",expanded?"true":"false"),button.textContent=expanded?strings.hide_explanation:strings.explain_grade},showPanel=()=>{panel.hidden=!1,panel.scrollIntoView({behavior:"smooth",block:"start"})};button.addEventListener("click",(()=>{if("true"===button.getAttribute("aria-expanded"))return panel.hidden=!0,void toggleButtonState(!1);var submissionid;(toggleButtonState(!0),loaded)?showPanel():(panel.innerHTML='<div class="ai-explain-loading">'.concat(strings.explanation_loading,"</div>"),panel.hidden=!1,(submissionid=config.submissionid,Ajax.call([{methodname:"local_hlai_grading_get_grade_explanation",args:{submissionid:submissionid}}])[0]).then((data=>(loaded=!0,renderExplanation(panel,data,strings)))).then(showPanel).catch((error=>{const message=error&&"no_ai_grade_found"===error.errorcode?strings.explanation_not_available:strings.explanation_error;panel.innerHTML='<p class="text-danger mb-0">'.concat(message,"</p>"),error&&"no_ai_grade_found"===error.errorcode||Notification.exception(error)})))}))})).catch(Notification.exception)}}}));

//# sourceMappingURL=grade_explanation.min.js.map