{"version":3,"file":"grade_explanation.min.js","sources":["../src/grade_explanation.js"],"sourcesContent":["define([\n    'jquery',\n    'core/ajax',\n    'core/notification',\n    'core/templates',\n    'core/str'\n], function($, Ajax, Notification, Templates, Str) {\n    const stringDefs = [\n        {key: 'explain_grade', component: 'local_hlai_grading'},\n        {key: 'hide_explanation', component: 'local_hlai_grading'},\n        {key: 'explanation_panel_title', component: 'local_hlai_grading'},\n        {key: 'explanation_panel_intro', component: 'local_hlai_grading'},\n        {key: 'explanation_loading', component: 'local_hlai_grading'},\n        {key: 'explanation_error', component: 'local_hlai_grading'},\n        {key: 'explanation_not_available', component: 'local_hlai_grading'},\n        {key: 'explanation_overall_heading', component: 'local_hlai_grading'},\n        {key: 'explanation_strengths_heading', component: 'local_hlai_grading'},\n        {key: 'explanation_strengths_empty', component: 'local_hlai_grading'},\n        {key: 'explanation_improvements_heading', component: 'local_hlai_grading'},\n        {key: 'explanation_improvements_empty', component: 'local_hlai_grading'},\n        {key: 'explanation_criteria_heading', component: 'local_hlai_grading'},\n        {key: 'explanation_examples_heading', component: 'local_hlai_grading'},\n        {key: 'explanation_expand_all', component: 'local_hlai_grading'},\n        {key: 'explanation_collapse_all', component: 'local_hlai_grading'},\n        {key: 'explanation_confidence', component: 'local_hlai_grading'},\n        {key: 'explanation_points', component: 'local_hlai_grading'},\n        {key: 'explanation_toggle_show', component: 'local_hlai_grading'},\n        {key: 'explanation_toggle_hide', component: 'local_hlai_grading'},\n    ];\n\n    const getStrings = () => Str.get_strings(stringDefs).then(function(results) {\n        const map = {};\n        results.forEach(function(value, index) {\n            map[stringDefs[index].key] = value;\n        });\n        return map;\n    });\n\n    const formatNumber = value => {\n        if (value === null || typeof value === 'undefined' || value === '') {\n            return 'â€“';\n        }\n        const number = Number(value);\n        if (Number.isNaN(number)) {\n            return value;\n        }\n        return Number.isInteger(number) ? number.toString() : number.toFixed(2);\n    };\n\n    const toParagraphs = text => {\n        if (!text) {\n            return [];\n        }\n        return text\n            .split(/\\n+/)\n            .map(part => part.trim())\n            .filter(Boolean);\n    };\n\n    const prepareTemplateContext = (data, strings) => {\n        const confidenceValue = Number(data.confidence);\n        const templateData = {\n            gradevalue: formatNumber(data.grade),\n            grademax: formatNumber(data.maxgrade),\n            hasconfidence: Number.isFinite(confidenceValue) && confidenceValue > 0,\n            confidence: strings.explanation_confidence.replace('{$a}', confidenceValue.toString()),\n            hasreasoning: !!data.reasoning,\n            reasoningparagraphs: toParagraphs(data.reasoning),\n            overallheading: strings.explanation_overall_heading,\n            strengthsheading: strings.explanation_strengths_heading,\n            improvementsheading: strings.explanation_improvements_heading,\n            improvementsempty: strings.explanation_improvements_empty,\n            criteriaheading: strings.explanation_criteria_heading,\n            examplesheading: strings.explanation_examples_heading,\n            expandall: strings.explanation_expand_all,\n            collapseall: strings.explanation_collapse_all,\n            strengthsempty: strings.explanation_strengths_empty,\n            strengths: data.strengths || [],\n            improvements: data.improvements || [],\n            hasstrengths: Array.isArray(data.strengths) && data.strengths.length > 0,\n            hasimprovements: Array.isArray(data.improvements) && data.improvements.length > 0,\n        };\n\n        templateData.criteria = (data.criteria || []).map((criterion, index) => {\n            const id = criterion.id || index;\n            let maxpoints = '';\n            if (typeof criterion.maxpoints !== 'undefined' && criterion.maxpoints !== null) {\n                maxpoints = criterion.maxpoints;\n            } else if (typeof criterion.max_score !== 'undefined') {\n                maxpoints = criterion.max_score;\n            }\n            const pointsLabel = strings.explanation_points\n                .replace('{$a->points}', formatNumber(criterion.points))\n                .replace('{$a->maxpoints}', formatNumber(maxpoints));\n\n            return {\n                id,\n                name: criterion.name || 'Criterion',\n                levelname: criterion.level_name || criterion.levelname || '',\n                pointslabel: pointsLabel,\n                togglelabel: strings.explanation_toggle_show,\n                hasreasoning: !!criterion.reasoning,\n                reasoningparagraphs: toParagraphs(criterion.reasoning),\n            };\n        });\n        templateData.hascriteria = templateData.criteria.length > 0;\n\n        templateData.hasexamples = Array.isArray(data.highlighted_examples) && data.highlighted_examples.length > 0;\n        templateData.examples = (data.highlighted_examples || []).map(example => ({\n            label: example.label || '',\n            text: example.text || '',\n            comment: example.comment || '',\n            typeclass: (example.type || '').toLowerCase() === 'strength' ? 'strength' : 'improvement',\n        }));\n\n        return templateData;\n    };\n\n    const insertPanel = (strings) => {\n        const table = document.querySelector('#page-mod-assign-view .submissionstatustable');\n        if (!table) {\n            return null;\n        }\n\n        const card = document.createElement('div');\n        card.className = 'card ai-grade-explain-card mb-4';\n        card.innerHTML = `\n            <div class=\"card-body\">\n                <div class=\"d-flex flex-column flex-md-row justify-content-between align-items-start gap-3\">\n                    <div>\n                        <h4 class=\"card-title mb-1\">${strings.explanation_panel_title}</h4>\n                        <p class=\"text-muted mb-0\">${strings.explanation_panel_intro}</p>\n                    </div>\n                    <button type=\"button\"\n                        id=\"explain-grade-btn\"\n                        class=\"btn btn-outline-primary\"\n                        aria-expanded=\"false\">\n                        ${strings.explain_grade}\n                    </button>\n                </div>\n                <div id=\"grade-explanation-panel\" class=\"mt-3\" hidden>\n                    <div class=\"ai-explain-loading\">\n                        ${strings.explanation_loading}\n                    </div>\n                </div>\n            </div>\n        `;\n\n        table.parentNode.insertBefore(card, table.nextSibling);\n        return card;\n    };\n\n    const fetchExplanation = submissionid => Ajax.call([{\n        methodname: 'local_hlai_grading_get_grade_explanation',\n        args: {submissionid},\n    }])[0];\n\n    const attachCriterionHandlers = (panel, strings) => {\n        panel.querySelectorAll('.criterion-explain-btn').forEach(button => {\n            button.addEventListener('click', () => {\n                const target = panel.querySelector('#reasoning-' + button.dataset.criterionid);\n                if (!target) {\n                    return;\n                }\n                const expanded = button.getAttribute('aria-expanded') === 'true';\n                if (expanded) {\n                    target.style.display = 'none';\n                    button.setAttribute('aria-expanded', 'false');\n                    button.textContent = strings.explanation_toggle_show;\n                } else {\n                    target.style.display = 'block';\n                    button.setAttribute('aria-expanded', 'true');\n                    button.textContent = strings.explanation_toggle_hide;\n                }\n            });\n        });\n\n        const expandAll = panel.querySelector('#expand-all-criteria');\n        const collapseAll = panel.querySelector('#collapse-all-criteria');\n\n        if (expandAll) {\n            expandAll.addEventListener('click', () => {\n                panel.querySelectorAll('.criterion-reasoning').forEach(reasoning => {\n                    reasoning.style.display = 'block';\n                });\n                panel.querySelectorAll('.criterion-explain-btn').forEach(button => {\n                    button.setAttribute('aria-expanded', 'true');\n                    button.textContent = strings.explanation_toggle_hide;\n                });\n            });\n        }\n\n        if (collapseAll) {\n            collapseAll.addEventListener('click', () => {\n                panel.querySelectorAll('.criterion-reasoning').forEach(reasoning => {\n                    reasoning.style.display = 'none';\n                });\n                panel.querySelectorAll('.criterion-explain-btn').forEach(button => {\n                    button.setAttribute('aria-expanded', 'false');\n                    button.textContent = strings.explanation_toggle_show;\n                });\n            });\n        }\n    };\n\n    const renderExplanation = (panel, data, strings) => {\n        const context = prepareTemplateContext(data, strings);\n        return Templates.render('local_hlai_grading/student_explanation', context)\n            .then(function(html, js) {\n                panel.innerHTML = html;\n                Templates.runTemplateJS(js);\n                attachCriterionHandlers(panel, strings);\n                return true;\n            });\n    };\n\n    const init = config => {\n        if (!config || !config.submissionid) {\n            return;\n        }\n\n        getStrings().then(strings => {\n            const card = insertPanel(strings);\n            if (!card) {\n                return undefined;\n            }\n\n            const button = card.querySelector('#explain-grade-btn');\n            const panel = card.querySelector('#grade-explanation-panel');\n            let loaded = false;\n\n            const toggleButtonState = expanded => {\n                button.setAttribute('aria-expanded', expanded ? 'true' : 'false');\n                button.textContent = expanded ? strings.hide_explanation : strings.explain_grade;\n            };\n\n            const showPanel = () => {\n                panel.hidden = false;\n                panel.scrollIntoView({behavior: 'smooth', block: 'start'});\n            };\n\n            const hidePanel = () => {\n                panel.hidden = true;\n            };\n\n            button.addEventListener('click', () => {\n                const expanded = button.getAttribute('aria-expanded') === 'true';\n                if (expanded) {\n                    hidePanel();\n                    toggleButtonState(false);\n                    return;\n                }\n\n                toggleButtonState(true);\n\n                if (loaded) {\n                    showPanel();\n                    return;\n                }\n\n                panel.innerHTML = `<div class=\"ai-explain-loading\">${strings.explanation_loading}</div>`;\n                panel.hidden = false;\n\n                // eslint-disable-next-line promise/no-nesting\n                fetchExplanation(config.submissionid)\n                    .then(data => {\n                        loaded = true;\n                        return renderExplanation(panel, data, strings);\n                    })\n                    .then(() => {\n                        showPanel();\n                        return true;\n                    })\n                    .catch(error => {\n                        const message = error && error.errorcode === 'no_ai_grade_found'\n                            ? strings.explanation_not_available\n                            : strings.explanation_error;\n                        panel.innerHTML = `<p class=\"text-danger mb-0\">${message}</p>`;\n                        if (!error || error.errorcode !== 'no_ai_grade_found') {\n                            Notification.exception(error);\n                        }\n                    });\n            });\n            return true;\n        }).catch(Notification.exception);\n    };\n\n    return {init};\n});\n"],"names":["define","$","Ajax","Notification","Templates","Str","stringDefs","key","component","formatNumber","value","number","Number","isNaN","isInteger","toString","toFixed","toParagraphs","text","split","map","part","trim","filter","Boolean","renderExplanation","panel","data","strings","context","confidenceValue","confidence","templateData","gradevalue","grade","grademax","maxgrade","hasconfidence","isFinite","explanation_confidence","replace","hasreasoning","reasoning","reasoningparagraphs","overallheading","explanation_overall_heading","strengthsheading","explanation_strengths_heading","improvementsheading","explanation_improvements_heading","improvementsempty","explanation_improvements_empty","criteriaheading","explanation_criteria_heading","examplesheading","explanation_examples_heading","expandall","explanation_expand_all","collapseall","explanation_collapse_all","strengthsempty","explanation_strengths_empty","strengths","improvements","hasstrengths","Array","isArray","length","hasimprovements","criteria","criterion","index","id","maxpoints","max_score","pointsLabel","explanation_points","points","name","levelname","level_name","pointslabel","togglelabel","explanation_toggle_show","hascriteria","hasexamples","highlighted_examples","examples","example","label","comment","typeclass","type","toLowerCase","prepareTemplateContext","render","then","html","js","innerHTML","runTemplateJS","querySelectorAll","forEach","button","addEventListener","target","querySelector","dataset","criterionid","getAttribute","style","display","setAttribute","textContent","explanation_toggle_hide","expandAll","collapseAll","attachCriterionHandlers","init","config","submissionid","get_strings","results","card","table","document","createElement","className","explanation_panel_title","explanation_panel_intro","explain_grade","explanation_loading","parentNode","insertBefore","nextSibling","insertPanel","loaded","toggleButtonState","expanded","hide_explanation","showPanel","hidden","scrollIntoView","behavior","block","call","methodname","args","catch","error","message","errorcode","explanation_not_available","explanation_error","exception"],"mappings":"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"}